<template>
  <div class="popup" v-keydown-esc="closeForm">
    <div class="popup-form">
      <div class="popup-form__header">
        <h2>Chọn tài sản ghi tăng</h2>
        <div class="header__close" @click="closeForm">
          <div class="tooltip">
            <div class="icon-close-popup"></div>
            <span class="tooltip__text">Đóng</span>
          </div>
        </div>
      </div>
      <div class="popup-form__body">
        <div class="content__toolbar">
          <div class="toolbar__filter">
            <div class="txt-box--filter">
              <div class="icon-search"></div>
              <input
                class="txt-box"
                placeholder="Tìm kiếm theo mã, tên tài sản"
                @keydown.enter="stateKeyDown()"
                v-model.trim="filterAsset"
              />
            </div>
          </div>
        </div>
        <base-table-vue
          size="calc(100% - 76px)"
          v-model="model"
          v-model:page="page"
          v-model:pageSize="pageSize"
          :totalPage="totalPage"
          :hasContextMenu="false"
          :totalRecord="totalRecord"
          :arrPage="arrPage"
          :moreInfo="moreInfo"
          ref="tableFixedAsset"
          :columns="columns"
          :cells="cells"
          send="fixed_asset_id"
          :get="[
            'fixed_asset_increment_code',
            'fixed_asset_code',
            'fixed_asset_name',
            'department_name',
            'cost',
            'accumulated_depreciation',
            'residual_value',
            'modified_date',
            'fixed_asset_increment_detail_id',
            'fixed_asset_increment_id',
            'fixed_asset_id',
          ]"
          :totalCellPaging="5"
          :isBorder="false"

        />
      </div>
      <div class="popup-form__footer">
        <button
          class="btn btn--primary"
          style="width: 120px"
          @click="btnOnClickSave"
        >
          Đồng ý
        </button>
        <button class="btn" style="width: 120px" @click="btnOnClickCancel">
          Huỷ bỏ
        </button>
      </div>
    </div>
  </div>
  <the-dialog-vue
    ref="dialog"
    v-show="isShowDialog"
    @onChoose="btnOnClickChooseDialog"
  />
  <loading-process-vue v-if="isLoadingProcess" />
</template>
<script>
export default {
  name: "FixedAssetList",
  props: {
    title: {
      type: String,
      required: true,
    },
    fixedAssetIds: {
      type: Array,
    },
    state: {
      type: Number,
      required: true,
    },
    deletedFixedAssets:Array
  },
  async created() {
    //gán dữ liệu mới sang dữ liệu cũ
    this.EX_FixedAsset = await this.getFixedAssets();

    //gán dữ liệu sang bên trạng thái tìm kiếm
    this.stateModel = this.EX_FixedAsset;

    //gán dữ liệu sang data
    this.model = this.MISACommon.getPaggingResult(
      this.stateModel,
      this.page,
      this.pageSize
    );
  },
  computed: {
    moreInfo: function () {
      var totalCost = this.stateModel.reduce((accumulator, object) => {
        return accumulator + object.cost;
      }, 0);
      var totalAccumulatedDepreciation = this.stateModel.reduce(
        (accumulator, object) => {
          return accumulator + object.accumulated_depreciation;
        },
        0
      );
      var totalResidualValue = this.stateModel.reduce((accumulator, object) => {
        return accumulator + object.residual_value;
      }, 0);
      return [totalCost, totalAccumulatedDepreciation, totalResidualValue];
    },
  /**
   * @description: Lấy tổng số trang
   * @param: {any}
   * Author: NNduc (24/04/2023)
   */
    totalPage: function () {
      return Math.ceil(this.stateModel.length / this.pageSize);
    },
    /**
     * @description: Lấy tổng số bản ghi
     * @param: {any}
     * Author: NNduc (24/04/2023)
     */
    totalRecord:function(){
      return this.stateModel.length;
    }
  },
  watch: {
    /**
     * Lấy dữ liệu tương ứng khi thay đổi giá trị page size
     * Author NNduc (13/3/2023)
     * @param {*} nVal giá trị mới lúc thay đổi
     */
    pageSize: function (nVal) {
      this.model = this.MISACommon.getPaggingResult(
      this.stateModel,
      this.page,
      nVal);
    },
    /**
     * Lấy dữ liệu tương ứng khi thay đổi giá trị trang
     * Author NNduc (13/3/2023)
     * @param {*} nVal giá trị mới lúc thay đổi
     */
    page: function (nVal) {
      this.model = this.MISACommon.getPaggingResult(
      this.stateModel,
      nVal,
      this.pageSize
    );
    },
  },
  data() {
    return {
      model: [], //lưu dữ liệu mới của ghi tăng
      EX_FixedAsset: [], //lưu trữ dữ liệu cũ của ghi tăng,
      stateModel: [], ////lưu dữ liệu trạng thái khi tìm kiếm ghi tài sản
      stateSearch: false, //lưu trạng thái search để đảm bảo vẫn còn danh sách tài sản
      isShowDialog: false,
      isLoadingProcess: false,
      focusName: null,
      filterAsset: "",
      page: 1,
      pageSize: 20,
      arrPage: ["10", "20", "30", "50", "100"],
      columns: [
        { type: "checkbox", width: 39, isResizing: false },
        { name: "STT", width: 52, isResizing: false, tooltip: "Số thứ tự" },
        { name: "Mã tài sản", width: 172, isResizing: true },
        { name: "Tên tài sản", width: 245, isResizing: true },
        { name: "Bộ phận sử dụng", width: 287, isResizing: true },
        { name: "Nguyên giá", width: 175, isResizing: false, align: "right" },
        {
          name: "HM/KH luỹ kế",
          width: 175,
          isResizing: false,
          tooltip: "Hao mòn/Khấu hao luỹ kế",
          align: "right",
        },
        {
          name: "Giá trị còn lại",
          width: 175,
          isResizing: false,
          align: "right",
        },
      ],
      cells: [
        { type: "checkbox" },
        { type: "sort" },
        { name: "fixed_asset_code" },
        { name: "fixed_asset_name" },
        { name: "department_name" },
        { name: "cost", align: "right", type: "money" },
        { name: "accumulated_depreciation", align: "right", type: "money" },
        { name: "residual_value", align: "right", type: "money" },
      ],
    };
  },
  methods: {
    /**
     * Hàm lấy tất cả tài sản theo bộ lọc
     * NNduc (13/3/2023)
     * @param {*} api đường dẫn api để lấy dữ liệu
     */
    getFixedAssets: async function () {
      //truyền tham số vào đường dẫn api;
      const api = this.MISAResoure.API.FixedAsset.Get();
      this.isLoadingProcess = true;
      var fixedAssets = [];
      await this.axios
        .get(api, this.fixedAssetIds)
        .then((response) => {
          fixedAssets = (response.data.Data).filter(
          (object) =>
            object.active == 0 && this.fixedAssetIds.indexOf(object.fixed_asset_id)==-1
        );
          this.isLoadingProcess = false;
        })
        .catch((e) => {
          this.isLoadingProcess = false;
          let title = this.MISAResoure.Dialog.Title.Warning + "</br>" + e;
          let titleBtnPr = this.MISAResoure.Dialog.Button.Close;
          this.showDialog(title, titleBtnPr);
        });
      return this.deletedFixedAssets.concat(fixedAssets);
    },

    /**
     * Hàm xử lý nhấn enter để tìm kiếm tài sản
     * Author NNduc(13/3/2023)
     */
    stateKeyDown: function () {
      if (this.filterAsset == "") {
        this.stateModel = this.EX_FixedAsset;
      } else {
        this.stateModel = this.EX_FixedAsset.filter(
          (object) =>
            object.fixed_asset_code
              .toLowerCase()
              .includes(this.filterAsset.toLowerCase()) ||
            object.fixed_asset_name
              .toLowerCase()
              .includes(this.filterAsset.toLowerCase())
        );
      }
      this.page = 1;
      this.model = this.MISACommon.getPaggingResult(
        this.stateModel,
        this.page,
        this.pageSize
      );
    },

    /**
     * Đóng form
     * Author: NNDuc (2/3/2023)
     */
    closeForm: function () {
      this.$emit("closeForm");
    },

    /**
     * Xử lý sự kiện click Huỷ form
     * Author: NNduc(5/3/2023)
     */
    btnOnClickCancel: function () {
      this.closeForm();
    },

    /**
     * Xử lý sự kiện click Lưu form
     * Author: NNduc(5/3/2023)
     */
    btnOnClickSave: function () {
      const fixedAssets = this.$refs.tableFixedAsset.getAllData();
      this.$emit("getFixedAssets", fixedAssets);
    },

    /**
     * @description: Hiện dialog lỗi
     * @param: {any}
     * Author: NNduc (10/04/2023)
     */
    showDialogError: function (errorCode) {
      var title = "";
      if (errorCode == this.MISAEnum.ErrorCode.DulicateCode) {
        title = this.MISAResoure.Dialog.Title.DulicateCode(
          this.MISAResoure.Form.FixedAsset.Lable.FixedAssetIncrementCode,
          this.model.fixed_asset_code
        );
        this.focusName = "fixedAssetIncrementCode";
        this.showBlurInputs();
        let titleBtnPr = this.MISAResoure.Dialog.Button.Close;
        this.showDialog(title, titleBtnPr);
      } else if (errorCode == this.MISAEnum.ErrorCode.InvalidData) {
        this.validateForm();
      } else {
        title = this.MISAResoure.Dialog.Title.Warning;
        let titleBtnPr = this.MISAResoure.Dialog.Button.Close;
        this.showDialog(title, titleBtnPr);
      }
    },

    /**
     * Hàm lấy trạng thái từ dialog
     * Author NNduc(5/5/2023)
     * @param {*} choose  gía trị được gửi từ dialog sang
     */
    btnOnClickChooseDialog: function (choose) {
      const NW_FixedAsset = JSON.stringify(this.model);
      if (
        choose == this.MISAResoure.Dialog.Button.Close ||
        choose == this.MISAResoure.Dialog.Button.No ||
        choose == this.MISAResoure.Dialog.Button.Yes ||
        (choose == this.MISAResoure.Dialog.Button.Cancel &&
          this.state == this.MISAEnum.FormState.Edit &&
          NW_FixedAsset != this.EX_FixedAssetIncrement)
      ) {
        this.$refs[this.focusName].autoFocusComplete();
        this.isShowDialog = false;
      } else if (
        choose == this.MISAResoure.Dialog.Button.Cancel ||
        choose == this.MISAResoure.Dialog.Button.DoNotSave
      ) {
        this.$emit("closeForm");
      } else {
        this.btnOnClickSave();
      }
    },

    /**
     * Hàm để chỉnh các thông số của dialog: title, button, title_button
     * Author NNduc (5/3/2023)
     * @param {*} titleDialog  tiêu đề của dialog
     * @param {*} titleBtnPr  tiêu đề của nút xanh
     * @param {*} titleBtnOut  tiêu đề của nút viền đen
     * @param {*} titleDialog  tiêu đề của nút viền trắng
     */
    showDialog: function (
      titleDialog,
      titleBtnPr = null,
      titleBtnOut = null,
      titleBtnSub = null
    ) {
      //set properties it's dialog
      const dialog = this.$refs.dialog;
      dialog.title = titleDialog;
      dialog.titleBtnPr = titleBtnPr;
      dialog.titleBtnOut = titleBtnOut; //button đường viền đen
      dialog.titleBtnSub = titleBtnSub; //button đường viền xanh
      //show dialog
      this.isShowDialog = true;
    },
  },
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
.popup-form__body .content__toolbar {
  padding: 16px;
  height: 76px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.toolbar__filter .txt-box--filter {
  height: 35px;
  width: 300px;
}

.popup-form__body {
  background-color: #ffff;
  height: calc(100% - 52px - 65px);
  border-top: 1px solid #dddddd;
}

.popup {
  background-color: rgba(0, 0, 0, 0.16);
  bottom: 0;
  left: 0;
  right: 0;
  top: 0;
  position: fixed;
  z-index: 3;
}
.popup-form {
  background-color: white;
  position: absolute;
  width: 1100px;
  height: 800px;
  top: 50%;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
  border-radius: 4px;
  left: 50%;
  transform: translate(-50%, -50%);
}

.popup-form__header {
  display: flex;
  justify-content: space-between;
  padding: 16px 16px 20px 16px;
  height: 65px;
  align-items: center;
}
.popup-form__header .header__close {
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.popup-form__grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  column-gap: 16px;
  grid-template-rows: 84px;
  /* row-gap: 20px; */
  border-radius: 3.5px;
  padding: 20px 16px;
  background-color: #ffff;
  height: 188px;
}
.popup-form__grid .grid__item:first-child {
  grid-column: 1/1;
}
.popup-form__grid .grid__item:last-child {
  grid-column: 1/4;
}

.popup-form__footer {
  padding: 0 16px;
  align-items: center;
  flex-direction: row-reverse;
  display: flex;
  column-gap: 16px;
  height: 52px;
  width: 100%;
  background-color: rgba(128, 128, 128, 0.151);
}
.popup-form__footer button {
  height: 36px;
  width: 110px;
}
</style>
